# Data Model: Signup Display Name

## Entity: User

**Resource**: `Huddlz.Accounts.User` (existing Ash resource)
**Table**: `users` (existing PostgreSQL table)
**Domain**: `Huddlz.Accounts`

### Modified Attributes

#### display_name

**Type**: `:string`
**Description**: Name the user wants others to identify them as

**Current Constraints**:
```elixir
attribute :display_name, :string do
  description "Name the user wants others to identify them as"
  allow_nil? true      # ‚Üê CHANGE TO false
  public? true
  constraints min_length: 1, max_length: 30  # ‚Üê CHANGE max to 70
end
```

**New Constraints**:
```elixir
attribute :display_name, :string do
  description "Name the user wants others to identify them as"
  allow_nil? false     # ‚Üê Required field
  public? true
  constraints min_length: 1, max_length: 70  # ‚Üê Increased max
end
```

**Validation Rules**:
- **Required**: Cannot be null or empty string
- **Min Length**: 1 character
- **Max Length**: 70 characters
- **Character Set**: All printable UTF-8 characters including:
  - Letters (any language/script)
  - Numbers
  - Spaces
  - Punctuation and special characters
  - Emojis and symbols
- **Uniqueness**: NOT unique (multiple users can share same display name)

**Visibility**:
- Public attribute (readable by all authenticated users)
- Displayed everywhere a user is referenced:
  - User profile pages
  - Huddl attendee lists
  - Comments and posts
  - Notifications
  - Search results
  - Any other user-facing contexts

**Editability**:
- Can be set during signup via `register_with_password` action
- Can be updated anytime via `update_display_name` action
- Users can only update their own display_name

### Modified Actions

#### create (existing, minor update needed)

**Current**:
```elixir
create :create do
  primary? true
  accept [:email, :display_name, :role, :confirmed_at, :hashed_password]
  change Huddlz.Accounts.User.Changes.SetDefaultDisplayName
end
```

**Analysis**: Already accepts display_name. The SetDefaultDisplayName change may need updating to handle required field properly.

#### register_with_password (auto-generated by AshAuthentication)

**Current Behavior**: Auto-generated by `password :password` strategy, accepts email and password

**Required Change**: Ensure display_name is accepted and validated

**Implementation Note**: Since display_name is a resource attribute with `allow_nil? false`, AshAuthentication's auto-generated action will automatically require it. No explicit configuration needed - the resource constraints drive the behavior.

**Expected Behavior After Change**:
- Registration requires email, password, password_confirmation, AND display_name
- Validation errors returned if display_name missing or invalid
- Display name stored with new user record

#### update_display_name (existing, needs validation update)

**Current**:
```elixir
update :update_display_name do
  description "Update a user's display_name"
  accept [:display_name]
  validate attribute_does_not_equal(:display_name, "")
  validate string_length(:display_name, min: 1, max: 30)  # ‚Üê CHANGE max to 70
end
```

**New**:
```elixir
update :update_display_name do
  description "Update a user's display_name"
  accept [:display_name]
  validate attribute_does_not_equal(:display_name, "")
  validate string_length(:display_name, min: 1, max: 70)  # ‚Üê Updated max
end
```

**Permissions** (no change needed):
```elixir
policy action(:update_display_name) do
  description "Users can update their own display_name"
  authorize_if expr(id == ^actor(:id))
end
```

### Database Migration

**Migration Name**: `update_user_display_name_constraints`

**Changes Required**:
1. Modify `display_name` column to `NOT NULL`
2. Backfill existing null values with default (email prefix)

**Generated Migration** (example):
```elixir
defmodule Huddlz.Repo.Migrations.UpdateUserDisplayNameConstraints do
  use Ecto.Migration

  def up do
    # Backfill existing null display names with email prefix
    execute """
    UPDATE users
    SET display_name = SPLIT_PART(email, '@', 1)
    WHERE display_name IS NULL
    """

    # Make column NOT NULL
    alter table(:users) do
      modify :display_name, :text, null: false
    end
  end

  def down do
    alter table(:users) do
      modify :display_name, :text, null: true
    end
  end
end
```

**Note**: Ash generates migrations based on resource changes. The above is illustrative - actual migration created by `mix ash.codegen`.

### Data Model Constraints Summary

| Constraint | Value | Enforcement |
|------------|-------|-------------|
| Required | Yes | Database (NOT NULL) + Ash validation |
| Min Length | 1 character | Ash validation (application level) |
| Max Length | 70 characters | Ash validation (application level) |
| Character Set | All UTF-8 printable | Elixir string type (native support) |
| Unique | No | No database constraint |
| Indexed | No | Not needed (not searchable per spec) |

### Relationships

No new relationships. Display name is a simple attribute of User entity.

### State Transitions

No state machine. Display name is a mutable attribute that can change at any time via the update_display_name action.

### Validation Error Messages

**Empty/Null Display Name**:
```elixir
%Ash.Error.Changes.InvalidAttribute{
  field: :display_name,
  message: "must be present",
  value: nil
}
```

**Display Name Too Long**:
```elixir
%Ash.Error.Changes.InvalidAttribute{
  field: :display_name,
  message: "length must be less than or equal to 70",
  value: "Very Long Name..."
}
```

**Display Name Too Short** (edge case - empty string):
```elixir
%Ash.Error.Changes.InvalidAttribute{
  field: :display_name,
  message: "length must be greater than or equal to 1",
  value: ""
}
```

### Testing Considerations

**Valid Test Cases**:
- `"John Doe"` - standard two-part name
- `"Madonna"` - single name
- `"Jos√© Garc√≠a"` - accented characters
- `"Mary-Jane O'Brien"` - hyphens and apostrophes
- `"Sam üéâ"` - emoji included
- `"A"` - minimum length (1 character)
- `String.duplicate("A", 70)` - maximum length (70 characters)
- `"ÊùéÊòé"` - non-Latin scripts
- `"user@example.com"` - email-like string (valid, just unusual)

**Invalid Test Cases**:
- `nil` - null value (should fail)
- `""` - empty string (should fail)
- `"   "` - whitespace only (should fail with empty check)
- `String.duplicate("A", 71)` - over maximum (should fail)

**Edge Cases**:
- Leading/trailing whitespace - no auto-trimming specified in requirements
- Mixed scripts (e.g., "Hello ‰∏ñÁïå") - should be valid
- Control characters - should be rejected by "printable characters" requirement
- Very long emoji sequences - count against 70 character limit

## Summary

The User entity requires minimal changes:
1. Update display_name attribute constraints (max 70, required)
2. Update update_display_name action validation (max 70)
3. Generate and run migration with backfill
4. Verify SetDefaultDisplayName change handles required field

No new entities, relationships, or complex state management needed. This is a straightforward attribute constraint modification.
